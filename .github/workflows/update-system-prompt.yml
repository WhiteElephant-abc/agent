name: Update System Prompt

on:
  push:
    paths:
      - "system_prompt.md"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      actions: read

    env:
      GH_TOKEN: ${{ secrets.REPOSITORY_VARIABLE_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update SYSTEM_PROMPT variable
        id: update
        run: |
          echo "正在更新 SYSTEM_PROMPT 变量..."

          if [ ! -f "system_prompt.md" ]; then
            echo "错误: system_prompt.md 文件不存在"
            exit 1
          fi

          SYSTEM_PROMPT_CONTENT="$(cat system_prompt.md)"

          OLD_VALUE=$(gh api \
            /repos/${{ github.repository }}/actions/variables/SYSTEM_PROMPT \
            --jq '.value' 2>/dev/null || echo "")

          gh api --method PATCH \
            /repos/${{ github.repository }}/actions/variables/SYSTEM_PROMPT \
            --raw-field name=SYSTEM_PROMPT \
            --raw-field value="$SYSTEM_PROMPT_CONTENT"

          echo "✓ SYSTEM_PROMPT 变量已更新"

          {
            echo "old_value<<EOF"
            echo "$OLD_VALUE"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  create-diff-issue:
    needs: update
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    env:
      GH_TOKEN: ${{ secrets.REPOSITORY_VARIABLE_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create diff issue
        run: |
          OLD_VALUE="${{ needs.update.outputs.old_value }}"
          NEW_VALUE="$(cat system_prompt.md)"

          DIFF_CONTENT=$(diff -u <(echo "$OLD_VALUE") <(echo "$NEW_VALUE") || echo "No diff available")

          ISSUE_BODY=$(cat <<EOF
[工作流运行 #${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

\`\`\`diff
$DIFF_CONTENT
\`\`\`
EOF
)

          gh issue create \
            --title "[工作流] 提示词更新 ${{ github.run_id }}" \
            --body "$ISSUE_BODY" \
            --label workflow \
            --label documentation