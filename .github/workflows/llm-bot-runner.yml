name: LLM Bot Runner

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'LLM task description'
        required: true
        type: string
      context:
        description: 'Task JSON context'
        required: true
        type: string

jobs:
  run-llm-bot:
    runs-on: ubuntu-latest
    env:
      LLM_TASK: ${{ inputs.task }}
      LLM_CONTEXT: ${{ inputs.context }}
      # GitHub identity tokens (4 names set)
      GITHUB_TOKEN: ${{ secrets.WEINAR_API_KEY }}
      GH_TOKEN: ${{ secrets.WEINAR_API_KEY }}
      GITHUBTOKEN: ${{ secrets.WEINAR_API_KEY }}
      GHTOKEN: ${{ secrets.WEINAR_API_KEY }}
      # Claude Code environment variable configuration
      ANTHROPIC_API_KEY: ${{ secrets.MIMO_API_KEY }}
      ANTHROPIC_AUTH_TOKEN: ${{ secrets.MIMO_API_KEY }}
      ANTHROPIC_BASE_URL: "https://api.xiaomimimo.com/anthropic"
      ANTHROPIC_DEFAULT_OPUS_MODEL: "mimo-v2-flash"
      ANTHROPIC_DEFAULT_SONNET_MODEL: "mimo-v2-flash"
      ANTHROPIC_DEFAULT_HAIKU_MODEL: "mimo-v2-flash"
      # MCP server environment variables
      CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}
      # System prompt
      SYSTEM_PROMPT: ${{ vars.SYSTEM_PROMPT }}
      # Other tokens
      MIMO_API_KEY: ${{ secrets.MIMO_API_KEY }}
      WEINAR_API_KEY: ${{ secrets.WEINAR_API_KEY }}
    permissions:
      contents: write
      pull-requests: write
      issues: write
      discussions: write
    defaults:
      run:
        working-directory: /home/runner/work
    steps:

      - name: Install Claude CLI
        run: |
          curl -fsSL https://claude.ai/install.sh | bash

      - name: Setup uv package manager
        uses: astral-sh/setup-uv@v7

      - name: Validate tokens and environment variables
        run: |
          echo "Validating environment variables..."
          # Validate GitHub token
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "Error: GITHUB_TOKEN not set"
            exit 1
          else
            echo "GitHub token is set"
          fi
          # Validate Anthropic auth token
          if [ -z "$ANTHROPIC_AUTH_TOKEN" ]; then
            echo "Error: ANTHROPIC_AUTH_TOKEN not set"
            exit 1
          else
            echo "Anthropic auth token is set"
          fi
          # Validate system prompt
          if [ -z "$SYSTEM_PROMPT" ]; then
            echo "Error: SYSTEM_PROMPT not set"
            exit 1
          else
            echo "System prompt is set"
          fi

      - name: Add MCP servers
        run: |
          # Add DuckDuckGo search server
          echo "Adding DuckDuckGo search server..."
          claude mcp add ddg-search -- uvx duckduckgo-mcp-server

          # Add Context7 HTTP server (if CONTEXT7_API_KEY is set)
          if [ -n "$CONTEXT7_API_KEY" ]; then
            echo "Adding Context7 HTTP server..."
            claude mcp add --transport http context7 https://mcp.context7.com/mcp \
              --header "CONTEXT7_API_KEY: $CONTEXT7_API_KEY"
          else
            echo "Warning: CONTEXT7_API_KEY not set, skipping Context7 server addition"
          fi
        env:
          CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}

      - name: Pre-configure Git (user, SSH, GPG signing)
        run: |
          echo "Configuring Git user information..."
          git config --global user.name "WhiteElephantIsNotARobot"
          git config --global user.email "257136373+WhiteElephantIsNotARobot@users.noreply.github.com"

          echo "Configuring SSH authentication..."
          # Create SSH directory
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write SSH private key from environment variable (if SSH_PRIVATE_KEY is provided)
          if [ -n "$SSH_PRIVATE_KEY" ]; then
            echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            echo "SSH private key written to ~/.ssh/id_rsa"

            # Start ssh-agent and add key
            eval "$(ssh-agent -s)"
            ssh-add ~/.ssh/id_rsa
            echo "SSH key added to ssh-agent"
          else
            echo "Warning: SSH_PRIVATE_KEY environment variable not set, skipping SSH configuration"
          fi

          # Add GitHub to known_hosts
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          chmod 644 ~/.ssh/known_hosts

          echo "Configuring GPG signing..."
          # Write GPG private key from environment variable (if GPG_PRIVATE_KEY is provided)
          if [ -n "$GPG_PRIVATE_KEY" ]; then
            echo "$GPG_PRIVATE_KEY" | gpg --import --batch
            echo "GPG private key imported"

            # Get GPG key ID
            GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG "257136373+WhiteElephantIsNotARobot@users.noreply.github.com" 2>/dev/null | grep sec | awk '{print $2}' | cut -d'/' -f2)
            if [ -n "$GPG_KEY_ID" ]; then
              # Configure git to use GPG signing
              git config --global user.signingkey "$GPG_KEY_ID"
              git config --global commit.gpgsign true
              git config --global gpg.program gpg
              echo "GPG signing configured, key ID: $GPG_KEY_ID"
            else
              echo "Warning: Could not find GPG key ID"
            fi
          else
            echo "Warning: GPG_PRIVATE_KEY environment variable not set, skipping GPG configuration"
          fi

          echo "Git pre-configuration complete"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: Run Claude Code as GitHub bot
        run: |
          echo "Running Claude Code..."
          echo "Original task: $LLM_TASK"
          echo "System prompt length: ${#SYSTEM_PROMPT} characters"

          # Write JSON context to file (save to /home/runner/ directory)
          echo "$LLM_CONTEXT" > /home/runner/context.json
          CONTEXT_CHARS=$(wc -m < /home/runner/context.json)
          echo "Context file size: $CONTEXT_CHARS characters"
          # Don't directly cat content to avoid log pollution
          echo ""

          # Build enhanced task string with instruction to read context.json
          ENHANCED_TASK=$(printf "%s\n\n> Task context saved to /home/runner/context.json, %s characters. Read this file to understand context!" "$LLM_TASK" "$CONTEXT_CHARS")
          echo "Enhanced task: $ENHANCED_TASK"

          claude \
            -p "$ENHANCED_TASK" \
            --system-prompt "$SYSTEM_PROMPT" \
            --allowedTools "Bash,TaskOutput,Edit,ExitPlanMode,Glob,Grep,KillShell,MCPSearch,NotebookEdit,Read,Skill,Task,TaskCreate,TaskGet,TaskList,TaskUpdate,WebFetch,WebSearch,Write,mcp__ddg-search__*,mcp__context7__*" \
            --output-format=stream-json \
            --verbose

          # Ensure working directory exists (inserted between three Claude calls)
          mkdir -p /home/runner/work

          # Self-check
          claude \
            -p "Please quickly self-check if you have left a reply on GitHub. If not, please leave a reply as required. Also quickly check the workspace to ensure all changes have been committed and pushed, and that a PR exists. Any unpushed changes will be permanently destroyed after this session ends!" \
            --system-prompt "$SYSTEM_PROMPT" \
            --allowedTools "Bash,TaskOutput,Edit,ExitPlanMode,Glob,Grep,KillShell,MCPSearch,NotebookEdit,Read,Skill,Task,TaskCreate,TaskGet,TaskList,TaskUpdate,WebFetch,WebSearch,Write,mcp__ddg-search__*,mcp__context7__*" \
            --output-format=stream-json \
            --verbose \
            --continue

          # Ensure working directory exists again
          mkdir -p /home/runner/work

          # Self-check again
          claude \
            -p "Please confirm again: all changes have been committed and pushed, and a PR exists. Any unpushed changes will be permanently destroyed after this session ends!" \
            --system-prompt "$SYSTEM_PROMPT" \
            --allowedTools "Bash,TaskOutput,Edit,ExitPlanMode,Glob,Grep,KillShell,MCPSearch,NotebookEdit,Read,Skill,Task,TaskCreate,TaskGet,TaskList,TaskUpdate,WebFetch,WebSearch,Write,mcp__ddg-search__*,mcp__context7__*" \
            --output-format=stream-json \
            --verbose \
            --continue
